name: deploy-infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: environment
      action:
        description: 'CDK action to perform'
        required: true
        type: choice
        options:
          - synth
          - diff
          - deploy
        default: diff
      stack_name:
        description: 'Specific stack to deploy (leave empty for all)'
        required: false
        type: string
        default: ''
      skip_tests:
        description: 'Skip tests (emergency deployments only)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        working-directory: infrastructure/cdk
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run pytest
        working-directory: infrastructure/cdk
        run: pytest tests/unit/ -v
      
      - name: Run black formatting check
        working-directory: infrastructure/cdk
        run: black --check .
      
      - name: Run ruff linting
        working-directory: infrastructure/cdk
        run: ruff check .
      
      - name: Run mypy type checking
        working-directory: infrastructure/cdk
        run: mypy stacks/ tests/

  deploy:
    name: Deploy (${{ inputs.environment }} - ${{ inputs.action }})
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || inputs.skip_tests)
    timeout-minutes: 30
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install CDK CLI
        run: npm install -g aws-cdk
      
      - name: Install Python dependencies
        working-directory: infrastructure/cdk
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Verify AWS access
        run: aws sts get-caller-identity
      
      - name: CDK Synth
        working-directory: infrastructure/cdk
        run: |
          cdk synth ${{ inputs.stack_name }} \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Diff
        if: inputs.action == 'diff' || inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          cdk diff ${{ inputs.stack_name }} \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Deploy
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          cdk deploy ${{ inputs.stack_name }} \
            --context environment=${{ inputs.environment }} \
            --require-approval never \
            --outputs-file cdk-outputs.json
      
      - name: Display Stack Outputs
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          if [ -f cdk-outputs.json ]; then
            echo "=== Stack Outputs ==="
            cat cdk-outputs.json | jq .
          fi
      
      - name: Upload CDK Outputs
        if: inputs.action == 'deploy'
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs-${{ inputs.environment }}
          path: infrastructure/cdk/cdk-outputs.json
          retention-days: 7
