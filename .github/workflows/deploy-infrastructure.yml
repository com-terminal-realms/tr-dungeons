name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: environment
      action:
        description: 'CDK action to perform'
        required: true
        type: choice
        options:
          - synth
          - diff
          - deploy
        default: diff
      stack_name:
        description: 'Specific stack to deploy (leave empty for all)'
        required: false
        type: string
        default: ''
      skip_tests:
        description: 'Skip tests (emergency deployments only)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        working-directory: infrastructure/cdk
        run: |
          pip install pipenv
          pipenv install --dev
      
      - name: Run pytest
        working-directory: infrastructure/cdk
        run: pipenv run pytest tests/unit/ -v
      
      - name: Run black formatting check
        working-directory: infrastructure/cdk
        run: pipenv run black --check --diff .
      
      - name: Run ruff linting
        working-directory: infrastructure/cdk
        run: pipenv run ruff check .
      
      - name: Run mypy type checking
        working-directory: infrastructure/cdk
        run: pipenv run mypy stacks/ tests/

  bootstrap:
    name: Bootstrap (${{ inputs.environment }} - ${{ inputs.action }})
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || inputs.skip_tests)
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install CDK CLI
        run: npm install -g aws-cdk
      
      - name: Install Python dependencies
        working-directory: infrastructure/cdk
        run: |
          pip install pipenv
          pipenv install
      
      - name: Configure AWS credentials (shared OIDC role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Verify AWS access
        run: aws sts get-caller-identity
      
      - name: CDK Synth Bootstrap
        working-directory: infrastructure/cdk
        run: |
          pipenv run cdk synth TRDungeonsBootstrap-${{ inputs.environment }} \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Diff Bootstrap
        if: inputs.action == 'diff' || inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          pipenv run cdk diff TRDungeonsBootstrap-${{ inputs.environment }} \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Deploy Bootstrap
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          pipenv run cdk deploy TRDungeonsBootstrap-${{ inputs.environment }} \
            --context environment=${{ inputs.environment }} \
            --require-approval never \
            --outputs-file bootstrap-outputs.json
      
      - name: Display Bootstrap Outputs
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          if [ -f bootstrap-outputs.json ]; then
            echo "=== Bootstrap Stack Outputs ==="
            cat bootstrap-outputs.json | jq .
          fi
      
      - name: Upload Bootstrap Outputs
        if: inputs.action == 'deploy'
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-outputs-${{ inputs.environment }}
          path: infrastructure/cdk/bootstrap-outputs.json
          retention-days: 7

  deploy:
    name: Deploy (${{ inputs.environment }} - ${{ inputs.action }})
    runs-on: ubuntu-latest
    needs: [bootstrap]
    if: always() && needs.bootstrap.result == 'success'
    timeout-minutes: 30
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install CDK CLI
        run: npm install -g aws-cdk
      
      - name: Install Python dependencies
        working-directory: infrastructure/cdk
        run: |
          pip install pipenv
          pipenv install
      
      - name: Configure AWS credentials (shared OIDC role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOYMENT_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
      
      - name: Get project-specific role ARN from SSM
        id: get-role
        run: |
          ROLE_ARN=$(aws ssm get-parameter \
            --name "/tr-dungeons/${{ inputs.environment }}/deployment-role-arn" \
            --query "Parameter.Value" \
            --output text)
          echo "role-arn=$ROLE_ARN" >> $GITHUB_OUTPUT
      
      - name: Configure AWS credentials (project-specific role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.get-role.outputs.role-arn }}
          aws-region: ${{ vars.AWS_REGION }}
          role-skip-session-tagging: true
      
      - name: Verify AWS access
        run: aws sts get-caller-identity
      
      - name: CDK Synth
        working-directory: infrastructure/cdk
        run: |
          STACK_FILTER="${{ inputs.stack_name }}"
          if [ -z "$STACK_FILTER" ]; then
            STACK_FILTER="TRDungeonsInfrastructure-${{ inputs.environment }}"
          fi
          pipenv run cdk synth $STACK_FILTER \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Diff
        if: inputs.action == 'diff' || inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          STACK_FILTER="${{ inputs.stack_name }}"
          if [ -z "$STACK_FILTER" ]; then
            STACK_FILTER="TRDungeonsInfrastructure-${{ inputs.environment }}"
          fi
          pipenv run cdk diff $STACK_FILTER \
            --context environment=${{ inputs.environment }}
      
      - name: CDK Deploy
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          STACK_FILTER="${{ inputs.stack_name }}"
          if [ -z "$STACK_FILTER" ]; then
            STACK_FILTER="TRDungeonsInfrastructure-${{ inputs.environment }}"
          fi
          pipenv run cdk deploy $STACK_FILTER \
            --context environment=${{ inputs.environment }} \
            --require-approval never \
            --outputs-file cdk-outputs.json
      
      - name: Display Stack Outputs
        if: inputs.action == 'deploy'
        working-directory: infrastructure/cdk
        run: |
          if [ -f cdk-outputs.json ]; then
            echo "=== Stack Outputs ==="
            cat cdk-outputs.json | jq .
          fi
      
      - name: Upload CDK Outputs
        if: inputs.action == 'deploy'
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs-${{ inputs.environment }}
          path: infrastructure/cdk/cdk-outputs.json
          retention-days: 7
